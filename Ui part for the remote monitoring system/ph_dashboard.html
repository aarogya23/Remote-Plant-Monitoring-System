<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pH Water Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f4f8;
    --panel: #ffffff;
    --border: #dde5ef;
    --accent: #0077cc;
    --accent2: #00a86b;
    --warn: #f57c00;
    --danger: #e53935;
    --text: #1a2a3a;
    --dim: #7a90a8;
    --good: #00a86b;
    --bad: #e53935;
    --neutral-ph: #0077cc;
    --acid: #f57c00;
    --alkaline: #7c3aed;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
    --shadow-hover: 0 6px 24px rgba(0,0,0,0.13);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(ellipse at 10% 10%, rgba(0,119,204,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 90% 90%, rgba(0,168,107,0.05) 0%, transparent 50%);
  }

  header {
    border-bottom: 2px solid var(--border);
    padding: 18px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    box-shadow: 0 2px 16px rgba(0,0,0,0.07);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 1.3rem;
    letter-spacing: 0.15em;
    color: var(--accent);
  }

  .logo span { color: var(--accent2); }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    color: var(--dim);
  }

  .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #ccc;
    transition: all 0.3s;
  }
  .dot.connected { background: var(--accent2); box-shadow: 0 0 8px rgba(0,168,107,0.5); animation: pulse 2s infinite; }
  .dot.error { background: var(--danger); box-shadow: 0 0 8px rgba(229,57,53,0.5); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  main { padding: 36px 40px; max-width: 1200px; margin: 0 auto; }

  /* ---- Connect Screen ---- */
  .connect-section {
    text-align: center;
    padding: 80px 20px;
  }

  .connect-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 10px;
    letter-spacing: 0.1em;
  }

  .connect-subtitle {
    color: var(--dim);
    margin-bottom: 48px;
    font-size: 0.9rem;
    letter-spacing: 0.06em;
  }

  .connect-btn {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 0.88rem;
    letter-spacing: 0.18em;
    padding: 16px 44px;
    background: var(--accent);
    border: 2px solid var(--accent);
    color: #fff;
    cursor: pointer;
    transition: all 0.25s;
    border-radius: 6px;
    text-transform: uppercase;
    box-shadow: 0 4px 16px rgba(0,119,204,0.25);
  }

  .connect-btn:hover {
    background: #005fa3;
    border-color: #005fa3;
    box-shadow: 0 6px 24px rgba(0,119,204,0.35);
    transform: translateY(-1px);
  }

  .connect-btn.outline {
    background: transparent;
    color: var(--accent2);
    border-color: var(--accent2);
    box-shadow: none;
  }
  .connect-btn.outline:hover {
    background: var(--accent2);
    color: #fff;
    box-shadow: 0 4px 16px rgba(0,168,107,0.3);
  }

  .connect-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .connect-hint {
    margin-top: 16px;
    color: var(--dim);
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    line-height: 1.7;
  }

  .divider {
    margin: 48px auto;
    max-width: 320px;
    border-top: 1px solid var(--border);
    padding-top: 28px;
  }

  .divider-label {
    color: var(--dim);
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    margin-bottom: 16px;
  }

  /* ---- Dashboard ---- */
  .dashboard { display: none; }
  .dashboard.visible { display: block; }

  /* Status banner */
  .status-banner {
    padding: 18px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    border-radius: 10px;
    background: var(--panel);
    border-left: 5px solid var(--border);
    box-shadow: var(--shadow);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 0.12em;
    transition: all 0.5s;
  }

  .status-banner.good { border-left-color: var(--good); background: #f0faf5; }
  .status-banner.bad  { border-left-color: var(--bad);  background: #fff5f5; }

  .status-text { font-size: 1.05rem; font-weight: 700; }

  /* Grid */
  .grid-top {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: box-shadow 0.2s;
  }

  .panel:hover { box-shadow: var(--shadow-hover); }

  .panel-label {
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    color: var(--dim);
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .panel-label::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    opacity: 0.5;
  }

  /* pH Panel */
  .ph-panel {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 36px 24px;
  }

  .ph-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 5rem;
    font-weight: 900;
    line-height: 1;
    color: var(--neutral-ph);
    transition: color 0.5s;
  }

  .ph-unit {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    color: var(--dim);
    letter-spacing: 0.3em;
    margin-top: 6px;
  }

  .ph-condition {
    margin-top: 14px;
    font-size: 0.82rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 6px 22px;
    border-radius: 20px;
    border: 2px solid currentColor;
    font-weight: 700;
    background: rgba(0,119,204,0.06);
    transition: all 0.4s;
  }

  /* Gauge */
  .gauge-panel { display: flex; flex-direction: column; align-items: center; }
  .gauge-wrap { position: relative; width: 200px; height: 115px; margin: 8px auto; }
  .gauge-svg { width: 100%; height: 100%; overflow: visible; }

  /* Metrics */
  .metric-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 2.1rem;
    font-weight: 700;
    color: var(--accent);
  }
  .metric-sub { font-size: 0.72rem; color: var(--dim); margin-top: 4px; letter-spacing: 0.06em; }

  .metric-divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }

  /* pH Scale */
  .ph-scale {
    height: 10px;
    border-radius: 5px;
    background: linear-gradient(90deg,
      #e53935 0%, #f57c00 20%, #fdd835 40%,
      #0077cc 57%, #7c3aed 80%, #4a148c 100%
    );
    position: relative;
    margin: 18px 0 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }

  .ph-scale-marker {
    position: absolute;
    top: -5px;
    width: 20px; height: 20px;
    background: white;
    border-radius: 50%;
    border: 3px solid var(--text);
    transform: translateX(-50%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: left 0.5s cubic-bezier(0.34,1.56,0.64,1);
  }

  .ph-scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.62rem;
    color: var(--dim);
    margin-top: 4px;
  }

  /* Chart */
  .chart-area {
    width: 100%;
    height: 160px;
    margin-top: 12px;
    overflow: hidden;
    border-radius: 6px;
    background: #f8fafc;
    border: 1px solid var(--border);
  }

  .chart-area svg { width: 100%; height: 100%; }

  /* Log */
  .log-panel { max-height: 200px; overflow-y: auto; }

  .log-entry {
    border-bottom: 1px solid var(--border);
    padding: 9px 0;
    font-size: 0.77rem;
    display: flex;
    gap: 16px;
    color: var(--dim);
    align-items: center;
  }

  .log-time { color: var(--accent); min-width: 82px; font-weight: 700; }
  .log-ph   { color: var(--text);   min-width: 62px; }
  .log-status-good { color: var(--good); font-weight: 700; }
  .log-status-bad  { color: var(--bad);  font-weight: 700; }

  .log-panel::-webkit-scrollbar { width: 4px; }
  .log-panel::-webkit-scrollbar-track { background: var(--bg); }
  .log-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .grid-bottom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .no-serial {
    background: #fff5f5;
    border: 1px solid var(--danger);
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 0.8rem;
    color: var(--danger);
    display: none;
    margin-bottom: 16px;
  }

  .disc-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--dim);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    padding: 10px 28px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .disc-btn:hover { border-color: var(--danger); color: var(--danger); background: #fff5f5; }

  .empty-msg {
    color: var(--dim);
    font-size: 0.8rem;
    padding: 24px 0;
    text-align: center;
  }

  @media (max-width: 768px) {
    main { padding: 20px; }
    header { padding: 14px 20px; }
    .grid-top { grid-template-columns: 1fr; }
    .grid-bottom { grid-template-columns: 1fr; }
    .ph-value { font-size: 3.5rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">pH<span>MONITOR</span></div>
  <div class="status-indicator">
    <div class="dot" id="connDot"></div>
    <span id="connLabel">DISCONNECTED</span>
  </div>
</header>

<main>
  <div id="noSerialWarn" class="no-serial">
    ⚠ Web Serial API not supported. Please use Google Chrome or Microsoft Edge.
  </div>

  <!-- Connect Screen -->
  <div id="connectSection" class="connect-section">
    <div class="connect-title">WATER QUALITY STATION</div>
    <div class="connect-subtitle">Real-time pH monitoring via Arduino Serial</div>

    <button class="connect-btn" id="connectBtn">⬡ Connect Arduino</button>
    <div class="connect-hint">
      Plug in your Arduino via USB, then click connect.<br>
      Baud rate must match your sketch (9600).
    </div>

    <div class="divider">
      <div class="divider-label">OR — TEST WITH DEMO DATA</div>
      <button class="connect-btn outline" id="demoBtn">▶ Demo Mode</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">

    <div class="status-banner good" id="statusBanner">
      <div>
        <div style="font-size:0.62rem;letter-spacing:0.18em;color:var(--dim);margin-bottom:4px;">WATER STATUS</div>
        <div class="status-text" id="statusText" style="color:var(--good);">INITIALIZING...</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:0.62rem;letter-spacing:0.18em;color:var(--dim);margin-bottom:4px;">LAST READING</div>
        <div id="lastReadTime" style="font-size:0.85rem;font-family:'Orbitron',sans-serif;">--:--:--</div>
      </div>
    </div>

    <div class="grid-top">

      <!-- pH Display -->
      <div class="panel ph-panel">
        <div class="panel-label">pH LEVEL</div>
        <div class="ph-value" id="phDisplay">--.-</div>
        <div class="ph-unit">pH UNITS</div>
        <div class="ph-condition" id="phCondition" style="color:var(--neutral-ph);">---</div>

        <div style="width:100%;margin-top:20px;">
          <div class="ph-scale">
            <div class="ph-scale-marker" id="phMarker" style="left:50%"></div>
          </div>
          <div class="ph-scale-labels">
            <span>0</span><span>2</span><span>4</span><span>6</span><span>7</span><span>8</span><span>10</span><span>14</span>
          </div>
        </div>
      </div>

      <!-- Gauge -->
      <div class="panel gauge-panel">
        <div class="panel-label">pH GAUGE</div>
        <div class="gauge-wrap">
          <svg class="gauge-svg" viewBox="0 0 200 110">
            <defs>
              <linearGradient id="gaugeTrack" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0%" stop-color="#e53935"/>
                <stop offset="50%" stop-color="#fdd835"/>
                <stop offset="100%" stop-color="#7c3aed"/>
              </linearGradient>
            </defs>
            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#e8edf4" stroke-width="14" stroke-linecap="round"/>
            <path id="gaugeArc" d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#0077cc" stroke-width="14" stroke-linecap="round"
              stroke-dasharray="0 251" style="transition: stroke-dasharray 0.8s ease, stroke 0.5s;"/>
            <line id="gaugeNeedle" x1="100" y1="100" x2="100" y2="28"
              stroke="#1a2a3a" stroke-width="2.5" stroke-linecap="round"
              style="transform-origin:100px 100px; transform:rotate(0deg); transition:transform 0.8s cubic-bezier(0.34,1.2,0.64,1);"/>
            <circle cx="100" cy="100" r="7" fill="white" stroke="#1a2a3a" stroke-width="2"/>
            <text x="14"  y="115" fill="#7a90a8" font-size="10" font-family="Share Tech Mono">0</text>
            <text x="95"  y="18"  fill="#7a90a8" font-size="10" font-family="Share Tech Mono">7</text>
            <text x="175" y="115" fill="#7a90a8" font-size="10" font-family="Share Tech Mono">14</text>
          </svg>
        </div>
        <div id="phGaugeLabel" style="text-align:center;font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:700;color:var(--accent);">-.-</div>
      </div>

      <!-- Metrics -->
      <div class="panel" style="display:flex;flex-direction:column;">
        <div>
          <div class="panel-label">VOLTAGE</div>
          <div class="metric-value" id="voltageDisplay">-.---</div>
          <div class="metric-sub">VOLTS (0 – 5V)</div>
        </div>
        <hr class="metric-divider">
        <div>
          <div class="panel-label">ANALOG RAW</div>
          <div class="metric-value" id="analogDisplay" style="color:var(--accent2);">----</div>
          <div class="metric-sub">ADC VALUE (0 – 1023)</div>
        </div>
        <hr class="metric-divider">
        <div>
          <div class="panel-label">TOTAL READINGS</div>
          <div class="metric-value" id="readingCount" style="color:var(--dim);">0</div>
          <div class="metric-sub">SAMPLES COLLECTED</div>
        </div>
      </div>

    </div>

    <div class="grid-bottom">
      <!-- Chart -->
      <div class="panel">
        <div class="panel-label">pH TREND — LAST 40 READINGS</div>
        <div class="chart-area">
          <svg id="chartSvg" viewBox="0 0 400 150" preserveAspectRatio="none">
            <defs>
              <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#0077cc" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#0077cc" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <line x1="0" y1="30"  x2="400" y2="30"  stroke="#e8edf4" stroke-width="1"/>
            <line x1="0" y1="75"  x2="400" y2="75"  stroke="#e8edf4" stroke-width="1"/>
            <line x1="0" y1="120" x2="400" y2="120" stroke="#e8edf4" stroke-width="1"/>
            <!-- Good zone -->
            <rect x="0" y="38" width="400" height="43" fill="rgba(0,168,107,0.06)"/>
            <polyline id="chartFill" points="" fill="url(#chartGrad)" opacity="1"/>
            <polyline id="chartLine" points="" fill="none" stroke="#0077cc" stroke-width="2.5" stroke-linejoin="round"/>
            <text x="4" y="28"  fill="#7a90a8" font-size="9" font-family="Share Tech Mono">pH 10</text>
            <text x="4" y="73"  fill="#7a90a8" font-size="9" font-family="Share Tech Mono">pH 7</text>
            <text x="4" y="118" fill="#7a90a8" font-size="9" font-family="Share Tech Mono">pH 4</text>
          </svg>
        </div>
      </div>

      <!-- Log -->
      <div class="panel">
        <div class="panel-label">READING LOG</div>
        <div class="log-panel" id="logPanel">
          <div class="empty-msg">Awaiting data...</div>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:8px;margin-bottom:20px;">
      <button class="disc-btn" id="disconnectBtn">DISCONNECT</button>
    </div>

  </div>
</main>

<script>
let port, reader, readBuffer = '';
let history = [], totalReadings = 0, demoInterval = null;

const connectSection = document.getElementById('connectSection');
const dashboard      = document.getElementById('dashboard');
const connectBtn     = document.getElementById('connectBtn');
const demoBtn        = document.getElementById('demoBtn');
const disconnectBtn  = document.getElementById('disconnectBtn');
const connDot        = document.getElementById('connDot');
const connLabel      = document.getElementById('connLabel');

if (!navigator.serial) {
  document.getElementById('noSerialWarn').style.display = 'block';
  connectBtn.disabled = true;
}

connectBtn.addEventListener('click', async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    setConnected('ARDUINO');
    readLoop();
  } catch(e) { console.error(e); }
});

async function readLoop() {
  const decoder = new TextDecoderStream();
  port.readable.pipeTo(decoder.writable);
  reader = decoder.readable.getReader();
  try {
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      readBuffer += value;
      const lines = readBuffer.split('\n');
      readBuffer = lines.pop();
      lines.forEach(parseLine);
    }
  } catch(e) { console.warn('Serial ended:', e); }
}

let pendingData = {};
function parseLine(line) {
  line = line.trim();
  if (!line) return;
  if (line.startsWith('Analog:')) {
    const m = line.match(/Analog:\s*(\d+).*Voltage:\s*([\d.]+)V.*pH:\s*([\d.]+)/);
    if (m) {
      pendingData.analog   = parseInt(m[1]);
      pendingData.voltage  = parseFloat(m[2]);
      pendingData.ph       = parseFloat(m[3]);
    }
  } else if (line.startsWith('Condition:')) {
    pendingData.condition   = line.replace('Condition:', '').trim();
    pendingData.waterStatus = pendingData.condition === 'Neutral' ? 'GOOD' : 'NOT GOOD';
    if (pendingData.ph !== undefined) { updateDashboard(pendingData); pendingData = {}; }
  } else if (line.includes('ERROR')) {
    showSensorError();
  }
}

demoBtn.addEventListener('click', () => {
  setConnected('DEMO MODE');
  let t = 0;
  demoInterval = setInterval(() => {
    t += 0.15;
    const ph = parseFloat((6.5 + Math.sin(t) * 1.8 + (Math.random()-0.5)*0.3).toFixed(2));
    const voltage = parseFloat((ph / 3.5).toFixed(3));
    const analog  = Math.round(voltage / 5.0 * 1023);
    let condition, waterStatus;
    if (ph < 6.0)      { condition = 'Acidic';   waterStatus = 'NOT GOOD'; }
    else if (ph > 7.5) { condition = 'Alkaline'; waterStatus = 'NOT GOOD'; }
    else               { condition = 'Neutral';  waterStatus = 'GOOD'; }
    updateDashboard({ analog, voltage, ph, condition, waterStatus });
  }, 2000);
});

disconnectBtn.addEventListener('click', async () => {
  if (demoInterval)   { clearInterval(demoInterval); demoInterval = null; }
  if (reader)         { await reader.cancel(); }
  if (port)           { await port.close().catch(()=>{}); }
  connDot.className   = 'dot';
  connLabel.textContent = 'DISCONNECTED';
  dashboard.classList.remove('visible');
  connectSection.style.display = '';
  history = []; totalReadings = 0;
});

function setConnected(label) {
  connDot.className   = 'dot connected';
  connLabel.textContent = label;
  connectSection.style.display = 'none';
  dashboard.classList.add('visible');
}

function phColor(ph) {
  if (ph < 6.0) return '#f57c00';
  if (ph > 7.5) return '#7c3aed';
  return '#0077cc';
}

function updateDashboard({ analog, voltage, ph, condition, waterStatus }) {
  totalReadings++;
  const color = phColor(ph);

  // pH value
  const phDisp = document.getElementById('phDisplay');
  phDisp.textContent = ph.toFixed(1);
  phDisp.style.color = color;

  const phCond = document.getElementById('phCondition');
  phCond.textContent   = condition.toUpperCase();
  phCond.style.color   = color;
  phCond.style.borderColor = color;
  phCond.style.background  = color + '12';

  // Gauge
  const pct    = Math.min(Math.max(ph / 14, 0), 1);
  const arcLen = pct * 251;
  const arc    = document.getElementById('gaugeArc');
  arc.setAttribute('stroke-dasharray', `${arcLen} 251`);
  arc.setAttribute('stroke', color);
  document.getElementById('gaugeNeedle').style.transform = `rotate(${(pct * 180) - 90}deg)`;
  const gaugeLabel = document.getElementById('phGaugeLabel');
  gaugeLabel.textContent = ph.toFixed(1);
  gaugeLabel.style.color = color;

  // Scale marker
  document.getElementById('phMarker').style.left = `${(ph / 14) * 100}%`;

  // Metrics
  document.getElementById('voltageDisplay').textContent  = voltage.toFixed(3) + 'V';
  document.getElementById('analogDisplay').textContent   = analog;
  document.getElementById('readingCount').textContent    = totalReadings;

  // Status banner
  const banner = document.getElementById('statusBanner');
  const statusText = document.getElementById('statusText');
  banner.className      = 'status-banner ' + (waterStatus === 'GOOD' ? 'good' : 'bad');
  statusText.textContent = `${waterStatus} — ${condition.toUpperCase()}`;
  statusText.style.color = waterStatus === 'GOOD' ? 'var(--good)' : 'var(--bad)';

  document.getElementById('lastReadTime').textContent = new Date().toLocaleTimeString();

  // History + chart
  history.push({ ph });
  if (history.length > 40) history.shift();
  updateChart(color);

  // Log
  addLog({ ph, voltage, condition, waterStatus, time: new Date() });
}

function updateChart(color) {
  if (history.length < 2) return;
  const W = 400, H = 150, minPH = 0, maxPH = 14;
  const padL = 38, padR = 10, padT = 10, padB = 10;
  const chartW = W - padL - padR, chartH = H - padT - padB;
  const points = history.map((d, i) => {
    const x = padL + (i / (Math.max(history.length - 1, 1))) * chartW;
    const y = padT + (1 - (d.ph - minPH) / (maxPH - minPH)) * chartH;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });
  const lastX = padL + chartW, bottomY = padT + chartH;
  document.getElementById('chartLine').setAttribute('points', points.join(' '));
  document.getElementById('chartFill').setAttribute('points', points.join(' ') + ` ${lastX},${bottomY} ${padL},${bottomY}`);
  // Update gradient color
  document.getElementById('chartLine').setAttribute('stroke', color || '#0077cc');
}

function addLog({ ph, voltage, condition, waterStatus, time }) {
  const log = document.getElementById('logPanel');
  if (log.querySelector('.empty-msg')) log.innerHTML = '';
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  const cls = waterStatus === 'GOOD' ? 'log-status-good' : 'log-status-bad';
  entry.innerHTML = `
    <span class="log-time">${time.toLocaleTimeString()}</span>
    <span class="log-ph">pH ${ph.toFixed(2)}</span>
    <span>${voltage.toFixed(3)}V</span>
    <span class="${cls}">${condition}</span>
  `;
  log.insertBefore(entry, log.firstChild);
  while (log.children.length > 50) log.removeChild(log.lastChild);
}

function showSensorError() {
  document.getElementById('phDisplay').textContent = 'ERR';
  document.getElementById('phDisplay').style.color = 'var(--danger)';
  document.getElementById('statusText').textContent = 'SENSOR ERROR';
  document.getElementById('statusBanner').className = 'status-banner bad';
}
</script>
</body>
</html>